{
  "name": "Fidelizaci贸n Narbos",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "f576ac1f-1397-416f-b3c6-6e2ab7dc4c08/chat",
        "options": {
          "allowedOrigins": "*"
        }
      },
      "id": "4284b36a-8434-4357-b331-e56949c681ad",
      "name": "Webhook (Captaci贸n)",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        160,
        -48
      ],
      "webhookId": "5f9f5654-30cc-49a5-8cb1-6fa975e0447b"
    },
    {
      "parameters": {
        "jsCode": "/* CDIGO UPDATE: Generador de Cup贸n nico */\nconst items = $input.all();\nconst item = items[0].json;\n\n// IMPORTANTE: Extraemos los datos del BODY, que es donde viven realmente\nconst userData = item.body; \n\nconst couponPrefix = 'NARBO-';\n\n// 1. Generar parte temporal (Timestamp base 36) para garantizar unicidad\n// Tomamos los 煤ltimos 4 caracteres del timestamp actual\nconst timePart = Date.now().toString(36).slice(-4).toUpperCase();\n\n// 2. Extraer los 煤ltimos 2 caracteres del nombre (o usar 'XX' si no hay nombre)\nconst nameSuffix = userData.name && userData.name.length >= 2 ? userData.name.slice(-2).toUpperCase() : 'XX';\n\n// 3. Combinar todo: Prefijo + Tiempo + SufijoNombre -> Ej: NARBO-KZ92pe \nconst fullCoupon = couponPrefix + timePart + nameSuffix;\n\nreturn [{\n  json: {\n    name: userData.name,       \n    email: userData.email,     \n    whatsapp: userData.whatsapp,\n    birthday: userData.birthday, \n    coupon_code: fullCoupon\n  }\n}];"
      },
      "id": "59e4fbc3-a950-4981-88fb-64691aecdec6",
      "name": "Generador de Cup贸n",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        368,
        -48
      ]
    },
    {
      "parameters": {
        "tableId": "clientes_fidelizacion",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "nombre",
              "fieldValue": "={{ $node[\"Generador de Cup贸n\"].json[\"name\"] }}\n"
            },
            {
              "fieldId": "email",
              "fieldValue": "={{ $node[\"Generador de Cup贸n\"].json[\"email\"] }}"
            },
            {
              "fieldId": "whatsapp",
              "fieldValue": "={{ $node[\"Generador de Cup贸n\"].json[\"whatsapp\"] }}"
            },
            {
              "fieldId": "codigo_descuento",
              "fieldValue": "={{ $node[\"Generador de Cup贸n\"].json[\"coupon_code\"] }}"
            },
            {
              "fieldId": "birthday",
              "fieldValue": "={{ $json.birthday }}"
            }
          ]
        }
      },
      "id": "6ec9a228-7e64-4753-8af6-632e8b18f843",
      "name": "Supabase (Guardar)",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        560,
        -48
      ],
      "credentials": {
        "supabaseApi": {
          "id": "5hkYuZVAhznvx7lf",
          "name": "Supabase Fidelizacion Narbo's Pro"
        }
      }
    },
    {
      "parameters": {
        "url": "=https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=https://n8n.srv1033442.hstgr.cloud/webhook/canje-QR?code={{ $node[\"Generador de Cup贸n\"].json[\"coupon_code\"] }}",
        "responseFormat": "file",
        "options": {}
      },
      "id": "5db8d1a1-d548-452c-b186-773223dc8f6a",
      "name": "Generar QR",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        768,
        -48
      ]
    },
    {
      "parameters": {
        "fromEmail": "contacto@narbossalon.com",
        "toEmail": "={{ $items(\"Generador de Cup贸n\")[0].json.email }}",
        "subject": "隆Bienvenido al Club Narbo's! Aqu铆 tienes tu descuento exclusivo ",
        "html": "=<!DOCTYPE html>\n<html lang=\"es\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <meta name=\"robots\" content=\"noindex, nofollow\">\n    <style>\n        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&family=Playfair+Display:wght@700&display=swap');\n    </style>\n</head>\n<body style=\"margin: 0; padding: 0; font-family: 'Montserrat', sans-serif; background-color: #f7f7f7; color: #333333;\">\n    <div style=\"max-width: 600px; margin: 40px auto; background-color: #ffffff; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05);\">\n        \n        <!-- Header con el Verde Narbo's -->\n        <div style=\"background-color: #6B755A; padding: 40px 20px; text-align: center;\">\n            <!-- Logo Oficial Producci贸n (Estable) -->\n            <img src=\"https://narbossalon.com/images/brand/logo_narbos.png\" alt=\"Narbo's Sal贸n\" style=\"height: 60px; margin-bottom: 20px; display: inline-block;\">\n            <h1 style=\"font-family: 'Playfair Display', serif; color: #ffffff; margin: 0; font-size: 28px;\">隆Bienvenida al Club Narbo's!</h1>\n        </div>\n\n        <!-- Cuerpo del mensaje -->\n        <div style=\"padding: 40px 30px; text-align: center;\">\n            <p style=\"font-size: 16px; line-height: 1.6; color: #666666; margin-bottom: 30px;\">\n                Hola <b>{{ $node[\"Generador de Cup贸n\"].json[\"name\"] }}</b>,<br><br>\n                Nos encanta tenerte aqu铆. Como agradecimiento por unirte a nuestro programa de fidelizaci贸n, te regalamos un beneficio exclusivo para tu pr贸xima visita.\n            </p>\n\n            <!-- Caja de C贸digo -->\n            <div style=\"background-color: #f9f9f9; padding: 25px; border-radius: 8px; border: 1px dashed #BE9D8A; display: inline-block; margin-bottom: 20px;\">\n                <p style=\"margin: 0; font-size: 14px; color: #888888; text-transform: uppercase; letter-spacing: 1px;\">Tu C贸digo Personal</p>\n                <p style=\"margin: 10px 0 0 0; font-size: 24px; font-weight: 600; color: #5B4636;\">{{ $node[\"Generador de Cup贸n\"].json[\"coupon_code\"] }}</p>\n            </div>\n\n            <!-- Secci贸n del QR Centrada -->\n            <div style=\"margin: 30px 0; text-align: center;\">\n                <div style=\"display: inline-block; padding: 15px; background-color: #ffffff; border: 1px solid #eeeeee; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05);\">\n                    <img src=\"https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=https://n8n.srv1033442.hstgr.cloud/webhook/canje-QR?code={{ $node['Generador de Cup贸n'].json['coupon_code'] }}\" \n                         alt=\"C贸digo QR de Descuento\" \n                         style=\"width: 200px; height: 200px; display: block; margin: 0 auto;\">\n                </div>\n                <p style=\"font-size: 13px; color: #999999; margin-top: 10px;\">Escanea este c贸digo en el sal贸n para redimir tu descuento</p>\n            </div>\n\n            <a href=\"https://wa.me/573059298379\" style=\"display: inline-block; background-color: #6C7053; color: #ffffff; text-decoration: none; padding: 14px 28px; border-radius: 30px; font-weight: 600; margin-top: 20px;\">Reservar Cita Ahora</a>\n        </div>\n\n        <!-- Pie de p谩gina -->\n        <div style=\"background-color: #333333; color: #ffffff; padding: 30px 20px; text-align: center; font-size: 12px;\">\n            <p style=\"margin-bottom: 10px;\">V谩lido por 180 d铆as (6 Meses). Sujeto a disponibilidad.</p>\n            <p style=\"margin: 0;\">漏 2026 Narbo's Sal贸n Spa. Ch铆a, Cundinamarca.</p>\n        </div>\n    </div>\n</body>\n</html>",
        "options": {}
      },
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2,
      "position": [
        976,
        -48
      ],
      "id": "8cce74dd-1251-4b3e-99cc-f504fc197c5b",
      "name": "Email: Enviar QR"
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook (Captaci贸n)": {
      "main": [
        [
          {
            "node": "Generador de Cup贸n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generador de Cup贸n": {
      "main": [
        [
          {
            "node": "Supabase (Guardar)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Supabase (Guardar)": {
      "main": [
        [
          {
            "node": "Generar QR",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generar QR": {
      "main": [
        [
          {
            "node": "Enviar QR",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "binaryMode": "separate",
    "availableInMCP": true
  },
  "versionId": "edb9a15d-e17f-4050-9fe4-0b2bc05bef95",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "fdffcaf648a7aa062da0ec843fff869b930e75adc5303a6a19e86b840cf683f2"
  },
  "id": "lDDC-Qp94RQO7w2NKXSBk",
  "tags": [
    {
      "updatedAt": "2026-01-16T14:38:20.363Z",
      "createdAt": "2026-01-16T14:38:20.363Z",
      "id": "2fMujRCNrT2UjAOq",
      "name": "Agencia de marketing"
    }
  ]
}